{% extends "!base.html" %}
{% block title %}Кошелек{% endblock %}

{% block head %}


<link rel="stylesheet"
      href="{{ url_for('static', path='assets/vendor/libs/typeahead-js/typeahead.css') }}"/>
<link rel="stylesheet"
      href="{{ url_for('static', path='assets/vendor/libs/datatables-bs5/datatables.bootstrap5.css') }}">
<link rel="stylesheet"
      href="{{ url_for('static', path='assets/vendor/libs/datatables-responsive-bs5/responsive.bootstrap5.css') }}">
<link rel="stylesheet"
      href="{{ url_for('static', path='assets/vendor/libs/apex-charts/apex-charts.css') }}">
<link rel="stylesheet"
      href="{{ url_for('static', path='assets/vendor/css/pages/card-analytics.css') }}"/>
<link rel="stylesheet"
      href="{{ url_for('static', path='assets/vendor/libs/bootstrap-select/bootstrap-select.css') }}"/>
{% endblock %}


{% block js %}
<script src="{{ url_for('static', path='assets/vendor/libs/apex-charts/apexcharts.js') }}"></script>
<script src="{{ url_for('static', path='assets/js/app-ecommerce-dashboard.js') }}"></script>
<script src="{{ url_for('static', path='assets/vendor/libs/bootstrap-select/bootstrap-select.js') }}"></script>


<!-- Create Bill -->
<script>
    document.getElementById('create-bill-form').addEventListener('submit', function (event) {

        event.preventDefault();

        var submitButton = document.querySelector('button[type="submit"]');
        submitButton.classList.add('disabled');

        const amountInput = document.getElementById('bill-amount');

        if (amountInput.value.length === 0) {
            toastr.error('Введите максимальное число использований')
            submitButton.classList.remove('disabled');
            return
        }

        var sourceInput = document.getElementById('bill-source')

        sourceInput = sourceInput.options[sourceInput.selectedIndex].value

        var currentPage = window.location.pathname;
        var parts = currentPage.split('/');
        var org_id = parts[parts.length - 1];

        const currentDomain = window.location.origin;
        const url = new URL('/payments/createBill', currentDomain);
        url.searchParams.append('org_id', org_id);
        url.searchParams.append('source_id', sourceInput);
        url.searchParams.append('amount', amountInput.value);
        submitButton.classList.remove('disabled');

        $.ajax({
            url: url,
            method: 'post',
            success: function () {
                location.reload()
            },

            error: function (data) {
                console.log(data)
                toastr.error(data.responseJSON.detail)
                submitButton.classList.remove('disabled');
            }
        });

    });
</script>

<!-- Get Sources -->
<script>
    $(document).ready(function () {

        $.ajax({

            url: '/payments/getActiveSources',
            type: 'GET',

            success: function (data) {
                var selectElement = $('#bill-source');

                $.each(data, function (index, item) {
                    var optionText = item.title + (item.description ? ' (' + item.description + ')' : '');
                    var optionValue = item.id;
                    var optionDataSubtext = item.number;

                    var option = $('<option>').text(optionText).attr('data-subtext', optionDataSubtext).val(optionValue);
                    selectElement.append(option);
                });

                selectElement.selectpicker('refresh');

            },

            error: function (data) {
                console.log(data)
                toastr.error('Ошибка получения реквизитов получателей. Обновите страницу и повторите попытку')
            }
        });

    });
</script>

<!-- Get Bills -->

<script>
    $(document).ready(function () {

        const url = window.location.href;

        var arr = url.split('/')
        var id = arr[arr.length - 1]

        $.ajax({

            url: '/payments/getOwnedBills?org_id=' + id,
            method: 'get',

            success: function (data) {
                if (data.length === 0) {
                    $('#users-list tbody').append('<tr><td>Участники отсутствуют</td></tr>');
                }
                $.each(data, function (index, item) {

                    var td_id = '<td><a href="/bill/' + item.id + '"><span class="fw-medium">#' + item.id + '</span></a></td>'

                    var date = new Date(item.date);
                    var formattedDate = date.getDate().toString().padStart(2, '0') + '.' + (date.getMonth() + 1).toString().padStart(2, '0') + '.' + date.getFullYear() + ', ' + date.toLocaleTimeString();

                    var td_date = '<td>' + formattedDate + '</td>';
                    var td_amount = '<td>' + item.amount + ' ₽</td>'
                    var td_source = '<td>' + item.source.title + ' (' + item.source.number + ')' + '</td>'

                    if (item.media !== null) {
                        var td_att = '<td><a href="/storage/get/' + item.media.storage_href + '" target="_blank"><span class="fw-medium">' + item.media.title + '.' + item.media.type + '</span></a></td>'
                    } else {
                        var td_att = '<td>—</td>'
                    }

                    var status = 'bg-label-warning'
                    if (item.status.id === 1) {
                        status = 'bg-label-success'
                    }

                    if (item.status.id === 4) {
                        status = 'bg-label-danger'
                    }

                    if (item.status.id === 5) {
                        status = 'bg-label-danger'
                    }

                    var td_status = '<td><span class="badge ' + status + '"> ' + item.status.title + ' </span></td>'

                    var td_actions =
                        '<td>' +
                        '<div class="d-flex align-items-center">' +
                        '<a href="/bill/' + item.id + '" class="text-body" target="_blank"><i class="bx bx-show mx-1"></i></a>\n' +
                        '</div>\n' +
                        '</td>'

                    var row = '<tr>' + td_id + td_date + td_amount + td_source + td_att + td_status + td_actions + '</tr>'

                    $('#bills-table tbody').append(row);

                });

                document.getElementById('loading-members').style.display = 'none';
                document.getElementById('div-mems').style.display = 'block';
            },
            error: function () {

                toastr.error('Ошибка загрузки списка пользователей')
                document.getElementById('loading-members').style.display = 'none';
            }

        });


    });

</script>
{% endblock %}


{% block content %}
<div class="container-xxl flex-grow-1 container-p-y">

    <div class="row mb-4">

        <div class="col">
            <div class="card h-100">
                <div class="row row-bordered g-0">
                    <div class="col-md-9">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Отчет за неделю</h5>
                            <small class="card-subtitle">График состояния кошелька</small>
                        </div>
                        <div class="card-body">
                            <div id="totalIncomeChart"></div>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="card-header d-flex justify-content-between">
                            <div>
                                <h5 class="card-title mb-0" id="org-name-card">Кошелек</h5>
                                <small class="card-subtitle" id="org-inn-card"></small>
                            </div>
                            <div class="dropdown">
                                <button class="btn p-0" type="button" id="totalIncome"
                                        data-bs-toggle="dropdown" aria-haspopup="true"
                                        aria-expanded="false">
                                    <i class="bx bx-dots-vertical-rounded"></i>
                                </button>
                                <div class="dropdown-menu dropdown-menu-end"
                                     aria-labelledby="totalIncome">
                                    <a class="dropdown-item" href="javascript:void(0);">Last 28 Days</a>
                                    <a class="dropdown-item" href="javascript:void(0);">Last Month</a>
                                    <a class="dropdown-item" href="javascript:void(0);">Last Year</a>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="report-list">
                                <div class="report-list-item rounded-2 mb-3">
                                    <div class="d-flex align-items-start">
                                        <div class="report-list-icon shadow-sm me-2">
                                            <img src="{{ url_for('static', path='assets/img/icons/unicons/wallet-info.png') }}"
                                                 width="22"
                                                 height="22" alt="Paypal">
                                        </div>
                                        <div class="d-flex justify-content-between align-items-end w-100 flex-wrap gap-2">
                                            <div class="d-flex flex-column">
                                                <span>Всего</span>
                                                <h5 class="mb-0">10 000 000 ₽</h5>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="report-list-item rounded-2 mb-3">
                                    <div class="d-flex align-items-start">
                                        <div class="report-list-icon shadow-sm me-2">
                                            <img src="{{ url_for('static', path='assets/img/icons/unicons/wallet.png') }}"
                                                 width="22" height="22" alt="Shopping Bag">
                                        </div>
                                        <div class="d-flex justify-content-between align-items-end w-100 flex-wrap gap-2">
                                            <div class="d-flex flex-column">
                                                <span>Заморожено</span>
                                                <h5 class="mb-0 text-warning">1 200 000 ₽</h5>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                                <div class="report-list-item rounded-2">
                                    <div class="d-flex align-items-start">
                                        <div class="report-list-icon shadow-sm me-2">
                                            <img src="{{ url_for('static', path='assets/img/icons/unicons/cc-success.png') }}"
                                                 width="22"
                                                 height="22" alt="Wallet">
                                        </div>
                                        <div class="d-flex justify-content-between align-items-end w-100 flex-wrap gap-2">
                                            <div class="d-flex flex-column">
                                                <span>Свободные</span>
                                                <h5 class="mb-0 text-success">10 000 000 ₽</h5>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--/ Total Income -->
        </div>

    </div>

    <div class="row">

        <div class="col">
            <div class="card">

                <div class="card-header">
                    <h5 class="card-title mb-0">История кошелька</h5>

                    <small class="card-subtitle">В этой карточке вы можете отредактировать права участников</small>
                </div>

                <div class="table-responsive text-nowrap">
                    <table class="table text-nowrap" id="users-list">
                        <thead>
                        <tr>
                            <th>ID</th>

                        </tr>
                        </thead>
                        <tbody class="table-border-bottom-0"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <div class="row mt-4">

        <div class="col">
            <div class="row">
                <div class="col-12 col-md-6 col-lg-12 mb-4">
                    <div class="card h-100">
                        <div class="row">
                            <div class="col">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Счета на пополнение
                                        <a href="#" data-bs-toggle="offcanvas"
                                           data-bs-target="#off-create-bill"
                                           aria-controls="off-create-bill">
                                            <i class="bx bxs-plus-square" data-bs-toggle="tooltip"
                                               data-bs-offset="0,8"
                                               data-bs-placement="top" data-bs-custom-class="tooltip-primary"
                                               data-bs-original-title="Создать">
                                            </i>
                                        </a>
                                    </h5>

                                    <small class="card-subtitle">Добавьте пополнение, выполните перевод и ожидайте
                                        подтверждения</small>
                                </div>

                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <table class="table text-nowrap" id="bills-table">
                                    <thead>
                                    <tr>
                                        <th>#ID</th>
                                        <th>Дата создания</th>
                                        <th>Сумма</th>
                                        <th>Способ</th>
                                        <th>Вложения</th>
                                        <th>Статус</th>
                                        <th>Действия</th>
                                    </tr>
                                    </thead>
                                    <tbody class="table-border-bottom-0">

                                    </tbody>
                                </table>
                            </div>
                        </div>


                    </div>
                </div>
            </div>
        </div>


    </div>
</div>


<div class="mt-3">
    <div class="offcanvas offcanvas-start" id="off-create-bill">

        <div class="offcanvas-header">
            <h5 id="off-create-bill-label" class="offcanvas-title">Новое пополнение</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"
                    aria-label="Закрыть"></button>
        </div>

        <div class="offcanvas-body my-auto mx-0 flex-grow-0">

            <form id="create-bill-form">

                <div class="mb-4 row">
                    <label for="bill-source" class="form-label">Способ</label>
                    <select id="bill-source" class="selectpicker w-100" data-style="btn-default"
                            data-show-subtext="true">
                    </select>
                </div>

                <div class="mb-4 row">
                    <label for="bill-amount" class="form-label">Сумма пополнения</label>
                    <div class="col">
                        <input class="form-control" type="number" placeholder="" id="bill-amount">
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">Создать</button>
            </form>

        </div>
    </div>
</div>


{% endblock %}