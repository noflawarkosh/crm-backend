{% extends "!base.html" %}
{% block title %}Товары{% endblock %}

{% block head %}


<link rel="stylesheet"
      href="{{ url_for('static', path='assets/vendor/libs/typeahead-js/typeahead.css') }}"/>
<link rel="stylesheet"
      href="{{ url_for('static', path='assets/vendor/libs/datatables-bs5/datatables.bootstrap5.css') }}">
<link rel="stylesheet"
      href="{{ url_for('static', path='assets/vendor/libs/datatables-responsive-bs5/responsive.bootstrap5.css') }}">
<link rel="stylesheet"
      href="{{ url_for('static', path='assets/vendor/libs/apex-charts/apex-charts.css') }}">
<link rel="stylesheet"
      href="{{ url_for('static', path='assets/vendor/css/pages/card-analytics.css') }}"/>
<link rel="stylesheet"
      href="{{ url_for('static', path='assets/vendor/libs/bootstrap-select/bootstrap-select.css') }}"/>

{% endblock %}


{% block js %}
<script src="{{ url_for('static', path='assets/vendor/libs/apex-charts/apexcharts.js') }}"></script>
<script src="{{ url_for('static', path='assets/js/app-ecommerce-dashboard.js') }}"></script>
<script src="{{ url_for('static', path='assets/vendor/libs/bootstrap-select/bootstrap-select.js') }}"></script>

<script>

    function disableProduct(id) {
        if (confirm('Подтвердите удаление товара #' + id)) {

            $.ajax({

                url: '/products/disable?product_id=' + id,
                method: 'get',

                success: function (data) {
                    document.getElementById('line-' + id).style.display = 'none'
                    toastr.success('Товар успешно удален')

                },
                error: function (data) {
                    console.log(data)
                    toastr.error('Ошибка загрузки списка товаров. ' + data.responseJSON.detail)
                }
            })
        }
    }


    $(document).ready(function () {

        const url = window.location.href;

        var arr = url.split('/')
        var id = arr[arr.length - 1]

        $.ajax({

            url: '/products/getOwned?org_id=' + id,
            method: 'get',

            success: function (data) {

                if (data.length !== 0) {
                    $('#product-list').show();
                }

                $.each(data, function (index, item) {
                    var pichref = '/storage/get/4m0Tqv66dBUakFPu.png'
                    var ext_url = 'https://www.wildberries.ru/catalog/' + item.wb_article + '/detail.aspx'
                    var price = null


                    if (item.media_id !== null) {
                        pichref = '/storage/get/' + item.media.storage_href
                    }


                    if (item.sizes.length === 1) {
                        if (item.sizes[0].wb_size_name == null) {

                            if (item.sizes[0].wb_in_stock === false) {
                                price = 'Нет в наличии'

                            } else {
                                price = item.sizes[0].wb_price / 100 + ' руб.'
                            }

                        }


                    } else {
                        var trs = ''

                        $.each(item.sizes, function (i, size) {
                            var p = null

                            var bdc = 'success'
                            var bdt = 'В наличии'

                            if (size.wb_in_stock === false) {
                                p = '—'
                                bdc = 'danger'
                                bdt = 'Не в наличии'

                            } else {
                                p = size.wb_price / 100 + ' руб.'
                            }

                            trs = trs + '                        <tr>\n' +
                                '                            <td>' + size.wb_size_origName + ' (' + size.wb_size_name + ')</td>\n' +
                                '                            <td>' + p + '</td>\n' +
                                '                            <td><span class="badge bg-label-' + bdc + '">' + bdt + '</span></td>\n' +
                                '                        </tr>\n'

                        })


                        var modal = '<div class="modal fade" id="modalToggle-' + item.id + '" aria-labelledby="modalToggleLabel-' + item.id + '" tabindex="-1" style="display: none;"\n' +
                            '         aria-hidden="true">\n' +
                            '        <div class="modal-dialog modal-dialog-centered">\n' +
                            '            <div class="modal-content">\n' +
                            '                <div class="modal-header">\n' +
                            '                    <h5 class="modal-title" id="modalToggleLabel-' + item.id + '">' + item.wb_article + '</h5>\n' +
                            '                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>\n' +
                            '                </div>\n' +
                            '                <div class="modal-body">\n' +
                            '                  <div class="table-responsive text-nowrap" >' +
                            '                    <table class="table text-nowrap">\n' +
                            '                        <thead>\n' +
                            '                        <tr>\n' +
                            '                            <th>Размер</th>\n' +
                            '                            <th>Стоимость</th>\n' +
                            '                            <th>Наличие</th>\n' +
                            '                        </tr>\n' +
                            '                        </thead>\n' +
                            '                        <tbody class="table-border-bottom-0">\n' + trs +
                            '                        </tbody>\n' +
                            '                    </table>\n' +
                            '                </div>\n</div>' +
                            '\n' +
                            '            </div>\n' +
                            '        </div>\n' +
                            '    </div>'

                        price = '<div><a href="##" data-bs-toggle="modal" data-bs-target="#modalToggle-' + item.id + '">Размеров: ' + item.sizes.length + '</a>\n' + modal + '\n</div>'

                    }


                    var row = '<tr id="line-' + item.id + '">\n' +
                        '                                        <td>' + item.id + '</td>\n' +
                        '                                        <td>\n' +
                        '                                            <div class="d-flex justify-content-start align-items-center product-name">\n' +
                        '                                                <div class="avatar-wrapper">\n' +
                        '                                                    <div class="avatar avatar me-2 rounded-2 bg-label-secondary">\n' +
                        '                                                        <img src="' + pichref + '">\n' +
                        '                                                    </div>\n' +
                        '                                                </div>\n' +
                        '                                                <div class="d-flex flex-column">\n' +
                        '                                                    <h6 class="text-body text-nowrap mb-0"><a target="_blank" href="' + ext_url + '">' + item.wb_title + '</a></h6>\n' +
                        '                                                    <small class="text-muted text-truncate d-none d-sm-block">' + item.wb_article + '</small>\n' +
                        '                                                </div>\n' +
                        '                                            </div>\n' +
                        '                                        </td>\n' +
                        '                                        <td><span>' + item.barcode + '</span></td>\n' +
                        '                                        <td>' + price + '</td>\n' +
                        '\n' +
                        '                                        <td>\n' +
                        '                                            <div class="d-inline-block text-nowrap">\n' +
                        '                                                <a href="##" onclick="disableProduct(' + item.id + ')" class="btn btn-sm btn-icon">\n' +
                        '                                                    <i class="bx bx-x"\n' +
                        '                                                       data-bs-toggle="tooltip"\n' +
                        '                                                       data-bs-offset="0,8"\n' +
                        '                                                       data-bs-placement="top"\n' +
                        '                                                       data-bs-custom-class="tooltip-primary"\n' +
                        '                                                       data-bs-original-title="Удалить">\n' +
                        '                                                    </i>\n' +
                        '                                                </a>\n<a href="' + ext_url + '" target="_blank" class="btn btn-sm btn-icon">\n' +
                        '                                                    <i class="bx bx-link-external"\n' +
                        '                                                       data-bs-toggle="tooltip"\n' +
                        '                                                       data-bs-offset="0,8"\n' +
                        '                                                       data-bs-placement="top"\n' +
                        '                                                       data-bs-custom-class="tooltip-primary"\n' +
                        '                                                       data-bs-original-title="Открыть на WB">\n' +
                        '\n' +
                        '                                                    </i>\n' +
                        '                                                </a>\n' +
                        '\n' +
                        '                                            </div>\n' +
                        '                                        </td>\n' +
                        '                                    </tr>'

                    $('#pr-l-b').append(row);


                });
                document.getElementById('prod-cntr').innerText = 'Всего: ' + data.length
                document.getElementById('loading-prods').style.display = 'none';
            },
            error: function () {

                toastr.error('Ошибка загрузки списка товаров')
                document.getElementById('loading-prods').style.display = 'none';
            }

        });


    });

</script>

<script>

    document.getElementById('create-product-form').addEventListener('submit', function (event) {

        event.preventDefault();

        var submitButton = document.querySelector('button[type="submit"]');

        submitButton.disabled = true

        const wb_url = document.getElementById('wb_url');
        const barcode = document.getElementById('barcode');

        if (wb_url.value.length === 0) {
            toastr.error('Введите ссылку')
            submitButton.disabled = false
            return
        }

        if (barcode.value.length === 0) {
            toastr.error('Введите штрих-код')
            submitButton.disabled = false
            return
        }

        var currentPage = window.location.pathname;
        var parts = currentPage.split('/');
        var org_id = parts[parts.length - 1];


        const currentDomain = window.location.origin;
        const url = new URL('/products/create', currentDomain);
        url.searchParams.append('org_id', org_id);
        url.searchParams.append('wb_url', wb_url.value);
        url.searchParams.append('barcode', barcode.value);
        submitButton.classList.remove('disabled');

        $.ajax({
            url: url,
            method: 'post',
            success: function (data) {
                location.reload()
            },

            error: function (data) {
                console.log(data)
                toastr.error(data.responseJSON.detail)
                submitButton.disabled = false
            }
        });

    });
</script>

{% endblock %}


{% block content %}
<div class="container-xxl flex-grow-1 container-p-y">

    <div class="row">

        <div class="col">
            <div class="card">

                <div class="card-header">
                    <h5 class="card-title mb-0">Товары организации
                        <a href="#" data-bs-toggle="offcanvas"
                           data-bs-target="#off-create-prod"
                           aria-controls="off-create-prod">
                            <i class="bx bxs-plus-square" data-bs-toggle="tooltip"
                               data-bs-offset="0,8"
                               data-bs-placement="top" data-bs-custom-class="tooltip-primary"
                               data-bs-original-title="Добавить">
                            </i>
                        </a>
                        <div class="spinner-border spinner-border-sm text-primary" role="status"
                             id="loading-prods">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </h5>
                    <small class="card-subtitle" id="prod-cntr"></small>
                </div>

                <div class="table-responsive text-nowrap" id="div-mems">
                    <table class="table text-nowrap" id="product-list" style="display: none;">
                        <thead>
                        <tr>
                            <th>#ID</th>
                            <th>Товар</th>
                            <th>Баркод</th>
                            <th>Стоимость</th>
                            <th>Действия</th>
                        </tr>
                        </thead>
                        <tbody class="table-border-bottom-0" id="pr-l-b">

                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

</div>


<div class="mt-3">
    <div class="offcanvas offcanvas-start" id="off-create-prod">

        <div class="offcanvas-header">
            <h5 id="off-create-product-label" class="offcanvas-title">Новый товар</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"
                    aria-label="Закрыть"></button>
        </div>

        <div class="offcanvas-body">

            <form id="create-product-form">

                <div class="mb-4 row">
                    <label for="wb_url" class="form-label">Ссылка на товар </label>
                    <div class="col">
                        <input class="form-control" type="text"
                               placeholder="wildberries.ru/catalog/000000000/detail.aspx?size=000000000"
                               id="wb_url">
                    </div>
                </div>

                <div class="mb-4 row">
                    <label for="barcode" class="form-label">Barcode (штрих-код) товара</label>
                    <div class="col">
                        <input class="form-control" type="text" placeholder="0000000" id="barcode">
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">Добавить</button>

            </form>


        </div>
    </div>
</div>


{% endblock %}